<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base target="_top">
    <title>카테고리 매칭 게임</title>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pretendard/dist/web/static/pretendard.css">
    <style>
        :root {
            --bg: #F2F4F6; /* Toss gray-100 */
            --text: #333D4B; /* gray-800 */
            --muted: #6B7684; /* gray-600 */

            --primary: #3182F6; /* blue-500 */
            --primary-hover: #1B64DA; /* blue-600 */
            --primary-shadow: rgba(49,130,246,0.3);

            --success: #00C473;
            --success-hover: #05A660;
            --danger: #FF5B56;
            --danger-hover: #E3493D;

            --desc-bg: #FFFFFF;
            --desc-border: #E5E8EB; /* gray-200 */
            --desc-hover-bg: #F9FAFB; /* gray-50 */

            --category-bg: #E8F3FF; /* blue-50 */
            --category-border: #3182F6; /* primary */
            --category-hover-bg: #DDEBFF;

            --drag-over-bg: #E8F3FF;
            --matched-bg: rgba(0, 196, 115, 0.12);
            --accent: #F59E0B; /* nickname accent (amber-500) */

            /* Radius & Spacing */
            --radius-container: 16px;
            --radius-card: 12px;
            --radius-button: 12px;

            --space-1: 8px;
            --space-2: 12px;
            --space-3: 16px;
            --space-4: 20px;
            --space-5: 24px;
            --space-6: 32px;

            /* Controls */
            --control-height: 44px;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, "Apple SD Gothic Neo", "Noto Sans KR", "Malgun Gothic", "맑은 고딕", sans-serif;
            background: var(--bg);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            background: white;
            border-radius: var(--radius-container);
            padding: var(--space-6);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 800px;
            width: 90%;
        }

        .email-form {
            text-align: center;
            margin-bottom: 30px;
        }

        .email-form h1 {
            color: var(--text);
            margin-bottom: var(--space-3);
            font-size: 28px;
        }

        .email-form input {
            padding: 12px 16px;
            border: 1px solid var(--desc-border);
            border-radius: var(--radius-button);
            font-size: 16px;
            width: 300px;
            margin-right: var(--space-2);
            outline: none;
            transition: border-color 0.3s;
            height: var(--control-height);
        }

        .email-form input:focus {
            border-color: var(--primary);
        }

        .nickname-note {
            margin-top: var(--space-2);
            font-size: 13px;
            color: var(--muted);
        }

        .nickname-row {
            display: inline-flex;
            gap: var(--space-2);
            align-items: center;
            justify-content: center;
            margin-top: var(--space-2);
        }

        .nickname-highlight {
            font-size: 18px;
            font-weight: 700;
            color: var(--accent);
        }

        .email-actions {
            display: flex;
            gap: var(--space-2);
            justify-content: center;
            align-items: center;
            margin-top: var(--space-5);
        }
        .secondary-btn {
            background: #FFFFFF;
            color: var(--text);
            border: 1px solid var(--desc-border);
        }
        .secondary-btn:hover {
            background: var(--desc-hover-bg);
        }

        .nickname-change-btn {
            color: var(--accent);
            background: transparent;
            border-color: var(--accent);
            height: 32px;
            font-size: 14px;
            padding: 4px 10px;
        }
        /* 강제 오버라이드: 어떤 경우에도 채워지지 않도록 */
        .btn.nickname-change-btn {
            background: transparent !important;
            border: 1px solid var(--accent) !important;
            color: var(--accent) !important;
        }
        .nickname-change-btn:hover {
            background: transparent;
        }
        .nickname-change-btn .icon {
            font-size: 14px;
            margin-right: 6px;
            line-height: 1;
            display: inline-block;
        }
        .nickname-change-btn .icon.spin {
            animation: spin 0.6s ease-in-out;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: var(--radius-button);
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            vertical-align: middle;
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Match game-start button height with email input */
        .email-form .btn {
            height: var(--control-height);
            padding: 0 var(--space-3);
        }

        .btn:hover {
            background: var(--primary-hover);
            transform: translateY(-2px);
        }

        /* 버튼 호버 컬러 */
        .save-btn:hover {
            background: var(--success-hover);
        }
        .reset-btn:hover {
            background: var(--danger-hover);
        }

        .game-area {
            display: none;
        }

        .game-header {
            text-align: center;
            margin-bottom: var(--space-5);
        }

        .game-header h2 {
            color: var(--text);
            margin-bottom: 10px;
        }

        .user-info {
            color: var(--muted);
            font-size: 14px;
        }

        .game-content {
            display: flex;
            justify-content: space-between;
            gap: var(--space-5);
            margin-bottom: var(--space-5);
        }

        .categories, .descriptions {
            flex: 1;
        }

        .categories h3, .descriptions h3 {
            text-align: center;
            margin-bottom: var(--space-3);
            color: var(--text);
            font-size: 20px;
        }

        /* 공용 헤더(좌: 기능설명, 우: 카테고리) */
        .lists-header {
            display: flex;
            justify-content: space-between;
            align-items: stretch;
            gap: var(--space-5);
            margin-bottom: var(--space-2);
        }
        .lists-header > div {
            flex: 1;
            display: flex;
            align-items: center;
        }
        .lists-controls {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            margin-top: var(--space-2);
            margin-bottom: var(--space-2);
        }
        .title-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }
        .lists-header h3 {
            margin: 0;
            color: var(--text);
            font-size: 20px;
        }

        .category-item {
            background: var(--category-bg);
            border: 1px solid var(--category-border);
            border-radius: var(--radius-card);
            padding: var(--space-3);
            margin-bottom: var(--space-3);
            cursor: pointer;
            transition: all 0.3s;
            user-select: none;
        }

        .category-item:hover {
            background: var(--category-hover-bg);
            transform: translateY(-2px);
            box-shadow: 0 8px 16px var(--primary-shadow);
        }

        .description-item {
            background: var(--desc-bg);
            border: 1px solid var(--desc-border);
            border-radius: var(--radius-card);
            padding: var(--space-3);
            margin-bottom: var(--space-3);
            cursor: move;
            transition: all 0.3s;
            user-select: none;
        }

        .description-item:hover {
            background: var(--desc-hover-bg);
            transform: translateY(-2px);
            box-shadow: 0 8px 16px var(--primary-shadow);
        }

        .category-item.drag-over {
            border-color: var(--primary);
            background: var(--drag-over-bg);
        }

        .descriptions.drag-over {
            outline: 1px dashed var(--primary);
            outline-offset: 6px;
            background: var(--drag-over-bg);
        }

        .description-item.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        .matched {
            background: #FFFFFF !important; /* 가독성을 위해 흰색 유지 */
            border-color: var(--success) !important; /* 매칭 강조는 테두리 색으로 */
        }

        /* 카테고리에 들어간 아이템은 조금 컴팩트하게 표시 */
        .description-item.in-category {
            margin-top: var(--space-2);
            font-size: 14px;
            cursor: move;
        }

        .result-section {
            text-align: center;
            margin-top: var(--space-5);
            width: 100%;
        }
        .result-actions {
            display: flex;
            gap: var(--space-2);
            justify-content: center;
            align-items: center;
            margin-bottom: var(--space-2);
        }
        /* 버튼 높이/패딩 통일로 시각 높이 일치 */
        .result-actions .btn {
            height: var(--control-height);
            padding: 0 var(--space-3);
            margin-top: 0;
        }
        .result-actions .save-btn { margin-top: 0; }
        .result-actions .secondary-btn { margin-top: 0; }
        #saveProgress {
            max-width: 360px;
            margin-left: auto;
            margin-right: auto;
        }

        .save-btn {
            background: var(--success);
            margin-top: var(--space-3);
        }

        .reset-btn {
            background: var(--danger);
            display: inline-flex;
            margin-bottom: var(--space-2);
        }

        .results-display {
            background: #FFFFFF;
            border: 1px solid var(--desc-border);
            border-radius: var(--radius-card);
            padding: var(--space-3);
            margin-top: var(--space-3);
            text-align: left;
        }

        .results-display h4 {
            margin-bottom: 15px;
            color: var(--text);
        }

        .match-result {
            padding: 8px 12px;
            margin: 6px 0;
            background: var(--desc-hover-bg);
            border-radius: var(--radius-card);
            border: 1px solid var(--desc-border);
            border-left: 4px solid var(--desc-border);
        }

        /* 저장 후 비활성화 상태 */
        .disable-interaction {
            pointer-events: none;
            opacity: 0.6;
        }

        /* 저장 진행 표시 바 */
        .progress-bar {
            position: relative;
            height: 4px;
            background: var(--desc-border);
            border-radius: 9999px;
            overflow: hidden;
            margin-top: var(--space-2);
        }
        .progress-bar .bar {
            position: absolute;
            left: -40%;
            width: 40%;
            height: 100%;
            background: var(--primary);
            border-radius: inherit;
            animation: indeterminate 1.2s ease-in-out infinite;
        }
        @keyframes indeterminate {
            0% { left: -40%; width: 40%; }
            50% { left: 20%; width: 60%; }
            100% { left: 100%; width: 40%; }
        }

        /* 카테고리 요약 */
        .category-summary {
            background: #FFFFFF;
            border: 1px solid var(--desc-border);
            border-radius: var(--radius-card);
            padding: var(--space-3);
            margin: var(--space-3) 0;
        }
        .category-summary h4 {
            margin: 0 0 var(--space-2) 0;
            font-size: 14px;
            color: var(--muted);
        }
        .category-summary .chips {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-1);
        }
        .category-summary .summary-desc {
            margin-top: var(--space-2);
            margin-bottom: var(--space-3);
            color: var(--muted);
            font-size: 13px;
        }
        .chip {
            display: inline-flex;
            align-items: center;
            padding: 6px 10px;
            background: var(--category-bg);
            border: 1px solid var(--category-border);
            border-radius: 9999px;
            font-size: 12px;
            color: var(--text);
        }

        @media (max-width: 768px) {
            .game-content {
                flex-direction: column;
            }
            
            .email-form input {
                width: 250px;
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="email-form" id="emailForm">
            <h1>카테고리 매칭 게임</h1>
            <p style="margin-bottom: 20px; color: #666;">아래 별명으로 바로 시작합니다.</p>
            <div class="nickname-row">
                <span id="nicknameDisplay" class="nickname-highlight"></span>
                <button class="btn secondary-btn nickname-change-btn" type="button" onclick="regenerateNickname()"><span class="icon" aria-hidden="true">🎲</span>별명 바꾸기</button>
            </div>
            <div class="email-actions">
                <button class="btn" type="button" onclick="startGame()">게임 시작</button>
            </div>
        </div>

        <div class="game-area" id="gameArea">
            <div class="game-header">
                <h2>카테고리와 기능을 매칭해보세요!</h2>
                <div class="user-info" id="userInfo"></div>
                <p style="color: #666; margin-top: 10px;">왼쪽 기능 설명을 드래그해서 오른쪽 적절한 카테고리에 놓아주세요.</p>
                <div style="background: #F2F4F6; border: 1px solid #E5E8EB; border-radius: 8px; padding: 12px; margin-top: 15px; font-size: 14px; color: #333D4B; text-align: left; line-height: 1.5;">
                    <strong>📝 게임방법:</strong><br>
                    1. 왼쪽 기능 설명을 보고 거기에 해당할 것 같은 카테고리에 드래그하세요.<br>
                    2. 1개의 카테고리에 여러개의 기능설명을 넣을 수 있어요.<br>
                    <strong>3. 정답은 없어요!!!!</strong><br>
                    4. 매칭을 완료 했으면 꼭 맨 끝에 '결과 저장' 버튼을 눌러 제출해주세요.<br>
                    5. 기능 설명이 없는 카테고리는 없어요. 1개 카테고리에 여러 기능이 매칭될 수도 있어요.
                </div>
            </div>

            <div class="category-summary">
                <h4>카테고리 요약</h4>
                <p class="summary-desc">카테고리는 이런 카테고리가 있어요. 미리 확인하고 고민해 보세요~!</p>
                <div class="chips" id="categorySummary"></div>
            </div>

            <div class="lists-controls">
                <button class="btn reset-btn" id="reset-button" type="button">초기화</button>
            </div>

            <div class="lists-header">
                <div class="descriptions-header">
                    <div class="title-row">
                        <h3>기능 설명</h3>
                    </div>
                </div>
                <div class="categories-header">
                    <div class="title-row">
                        <h3>카테고리</h3>
                    </div>
                </div>
            </div>

            <div class="game-content">
                <div class="descriptions" ondrop="dropToLeft(event)" ondragover="allowDrop(event)">
                    <div class="description-item" draggable="true" data-description="A" ondragstart="drag(event)">
                        <strong>고객과 상담할 기능이 필요해</strong>
                    </div>
                    <div class="description-item" draggable="true" data-description="B" ondragstart="drag(event)">
                        <strong>구매평을 더 잘 보여주고 싶어. 아임웹 리뷰 기능으로는 부족해</strong>
                    </div>
                    <div class="description-item" draggable="true" data-description="C" ondragstart="drag(event)">
                        <strong>사이트에 조건 걸어서 팝업 띄워야하는데 아임웹은 안돼네</strong>
                    </div>
                    <div class="description-item" draggable="true" data-description="D" ondragstart="drag(event)">
                        <strong>특정 고객을 타겟해서 카카오톡 메세지 보내고 싶어</strong>
                    </div>
                    <div class="description-item" draggable="true" data-description="E" ondragstart="drag(event)">
                        <strong>메타 광고 연동해야해</strong>
                    </div>
                    <div class="description-item" draggable="true" data-description="F" ondragstart="drag(event)">
                        <strong>지그재그에서 상품 올리고 주문 받아야해</strong>
                    </div>
                    <div class="description-item" draggable="true" data-description="G" ondragstart="drag(event)">
                        <strong>인스타그램 콘텐츠 연동이 필요해</strong>
                    </div>
                    <div class="description-item" draggable="true" data-description="H" ondragstart="drag(event)">
                        <strong>우리가 만든영상 올려야하는데 어떻게 올리지</strong>
                    </div>
                    <div class="description-item" draggable="true" data-description="I" ondragstart="drag(event)">
                        <strong>택배 혼자 관리 힘들다</strong>
                    </div>
                    <div class="description-item" draggable="true" data-description="J" ondragstart="drag(event)">
                        <strong>반찬 정기구독 결제를 받아야해</strong>
                    </div>
                    <div class="description-item" draggable="true" data-description="K" ondragstart="drag(event)">
                        <strong>상품 상세 페이지 만드는 게 너무 어려워. 솔루션 없나</strong>
                    </div>
                    <div class="description-item" draggable="true" data-description="L" ondragstart="drag(event)">
                        <strong>네이버 쇼핑 카탈로그? EP? 연동해야하는데</strong>
                    </div>
                    <div class="description-item" draggable="true" data-description="M" ondragstart="drag(event)">
                        <strong>내 사이트로 어떻게 들어오는지 알고 전환율 같은 게 궁금해</strong>
                    </div>
                    <div class="description-item" draggable="true" data-description="N" ondragstart="drag(event)">
                        <strong>사이트 특성상 성인인증이 꼭 필요한데 어떻게 하지</strong>
                    </div>
                    <div class="description-item" draggable="true" data-description="O" ondragstart="drag(event)">
                        <strong>우리 사이트에 네이버페이 붙일 거야</strong>
                    </div>
                </div>

                <div class="categories">
                    <div class="category-item" data-category="A" ondrop="drop(event)" ondragover="allowDrop(event)">
                        <strong>CRM/팝업/모달</strong>
                        <div class="matched-items" id="categoryA-items"></div>
                    </div>
                    <div class="category-item" data-category="B" ondrop="drop(event)" ondragover="allowDrop(event)">
                        <strong>리뷰</strong>
                        <div class="matched-items" id="categoryB-items"></div>
                    </div>
                    <div class="category-item" data-category="C" ondrop="drop(event)" ondragover="allowDrop(event)">
                        <strong>고객상담 및 CS관리</strong>
                        <div class="matched-items" id="categoryC-items"></div>
                    </div>
                    <div class="category-item" data-category="D" ondrop="drop(event)" ondragover="allowDrop(event)">
                        <strong>회원가입 최적화</strong>
                        <div class="matched-items" id="categoryD-items"></div>
                    </div>
                    <div class="category-item" data-category="E" ondrop="drop(event)" ondragover="allowDrop(event)">
                        <strong>광고 관리</strong>
                        <div class="matched-items" id="categoryE-items"></div>
                    </div>
                    <div class="category-item" data-category="F" ondrop="drop(event)" ondragover="allowDrop(event)">
                        <strong>주문관리/판매채널</strong>
                        <div class="matched-items" id="categoryF-items"></div>
                    </div>
                    <div class="category-item" data-category="G" ondrop="drop(event)" ondragover="allowDrop(event)">
                        <strong>SNS/소셜미디어</strong>
                        <div class="matched-items" id="categoryG-items"></div>
                    </div>
                    <div class="category-item" data-category="H" ondrop="drop(event)" ondragover="allowDrop(event)">
                        <strong>영상/라이브커머스/숏폼</strong>
                        <div class="matched-items" id="categoryH-items"></div>
                    </div>
                    <div class="category-item" data-category="I" ondrop="drop(event)" ondragover="allowDrop(event)">
                        <strong>배송/물류/풀필먼트</strong>
                        <div class="matched-items" id="categoryI-items"></div>
                    </div>
                    <div class="category-item" data-category="J" ondrop="drop(event)" ondragover="allowDrop(event)">
                        <strong>결제</strong>
                        <div class="matched-items" id="categoryJ-items"></div>
                    </div>
                    <div class="category-item" data-category="K" ondrop="drop(event)" ondragover="allowDrop(event)">
                        <strong>콘텐츠 제작/관리</strong>
                        <div class="matched-items" id="categoryK-items"></div>
                    </div>
                    <div class="category-item" data-category="L" ondrop="drop(event)" ondragover="allowDrop(event)">
                        <strong>통계 및 매출 분석</strong>
                        <div class="matched-items" id="categoryL-items"></div>
                    </div>
                    <div class="category-item" data-category="N" ondrop="drop(event)" ondragover="allowDrop(event)">
                        <strong>인증/보안/사이트 관리</strong>
                        <div class="matched-items" id="categoryN-items"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="result-section" id="resultSection" style="display: none;">
                <div class="result-actions">
                    <button class="btn save-btn" id="save-button">결과 저장</button>
                    <button class="btn secondary-btn" id="back-button" type="button" style="display: none;">다시하기</button>
                </div>
                <div id="saveProgress" class="progress-bar" style="display: none;"><div class="bar"></div></div>
                <div class="results-display" id="resultsDisplay" style="display: none;">
                    <h4>매칭 결과:</h4>
                    <div id="matchResults"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwazelzgjxdHsw3cGlFRTGaW7RypVEl6N-B-m_BaFtNlMdWblaGHCBD9g5g8Rl2TCw/exec';

        const categoryLabels = {
            A: 'CRM/팝업/모달',
            B: '리뷰',
            C: '고객상담 및 CS관리',
            D: '회원가입 최적화',
            E: '광고 관리',
            F: '판매채널 및 주문관리',
            G: 'SNS/소셜미디어',
            H: '영상/라이브커머스/숏폼',
            I: '배송 및 물류',
            J: '결제',
            K: '콘텐츠 제작/관리',
            L: '통계 및 매출 분석',
            N: '인증/보안/사이트 관리'
        };

        const descriptionLabels = {
            A: '고객과 상담할 기능이 필요해',
            B: '구매평을 더 잘 보여주고 싶어. 아임웹 리뷰 기능으로는 부족해',
            C: '온사이트 팝업 띄울거야',
            D: '타겟해서 카카오톡 메세지 보내기',
            E: '메타 광고 연동해야해',
            F: '다양한 판매 채널 관리하기', 
            G: '인스타그램 콘텐츠 연동이 필요해',
            H: '우리가 만든영상 올려야하는데 어떻게 올리지',
            I: '택배 혼자 관리 힘들다',
            J: '반찬 정기구독 결제를 받아야해',
            K: '상품 상세 페이지 만드는 게 너무 어려워. 솔루션 없나',
            L: '네이버 쇼핑 카탈로그? EP? 연동해야하는데',
            M: '내 사이트로 어떻게 들어오는지 알고 전환율 같은 게 궁금해',
            N: '사이트 특성상 성인인증이 꼭 필요한데 어떻게 하지',
            O: '우리 사이트에 네이버페이 붙일 거야'
        };

        let userEmail = '';
        let userNickname = '';
        let gameResults = {};

        // 단순 피셔-예이츠 셔플 구현
        function shuffleArray(arr) {
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        // 컨테이너 내부의 특정 셀렉터에 해당하는 자식 요소들을 랜덤 재배치
        function shuffleChildren(container, itemSelector) {
            if (!container) return;
            const items = Array.from(container.querySelectorAll(itemSelector));
            shuffleArray(items).forEach(el => container.appendChild(el));
        }

        let initialOrderIndex = {};

        document.addEventListener('DOMContentLoaded', () => {
            const saveButton = document.getElementById('save-button');
            if (saveButton) {
                saveButton.addEventListener('click', handleSaveButtonClick);
            }

            const resetButton = document.getElementById('reset-button');
            if (resetButton) {
                resetButton.addEventListener('click', handleResetButtonClick);
            }
            const backButton = document.getElementById('back-button');
            if (backButton) {
                backButton.addEventListener('click', handleBackButtonClick);
            }

            // 페이지 열릴 때마다 설명과 카테고리 순서를 랜덤하게 섞기
            const descriptionsContainer = document.querySelector('.descriptions');
            const categoriesContainer = document.querySelector('.categories');
            shuffleChildren(descriptionsContainer, '.description-item');
            shuffleChildren(categoriesContainer, '.category-item');

            // 섞인 이후 사용자에게 보이는 초기 순서를 기록
            const items = document.querySelectorAll('.descriptions .description-item');
            items.forEach((el, idx) => {
                const id = el.getAttribute('data-description');
                if (id) initialOrderIndex[id] = idx;
            });

            // 카테고리 요약 칩 생성
            renderCategorySummary();

            // 별명 생성/표시
            userNickname = getOrCreateNickname();
            const nickEl = document.getElementById('nicknameDisplay');
            if (nickEl) {
                nickEl.textContent = `${userNickname}`;
            }
        });

        function getOrCreateNickname() {
            // 저장하지 않고 매 로드마다 새 별명 생성
            return generateNickname();
        }

        function regenerateNickname() {
            // 회전 애니메이션
            const btn = document.querySelector('.nickname-change-btn');
            const icon = btn ? btn.querySelector('.icon') : null;
            if (icon) {
                icon.classList.remove('spin');
                void icon.offsetWidth; // reflow to restart animation
                icon.classList.add('spin');
            }
            const nick = generateNickname();
            userNickname = nick;
            const nickEl = document.getElementById('nicknameDisplay');
            if (nickEl) nickEl.textContent = `${userNickname}`;
        }

        function generateNickname() {
            const adjectives = ['푸른','반짝이는','빠른','용감한','귀여운','신비한','멋진','활기찬','영리한','다정한','예쁜','수줍은','깜찍한','간지나는'];
            const animals = ['고래','여우','호랑이','판다','독수리','사자','돌고래','나비','펭귄','늑대','기린','공작','오소리','너구리'];
            const adj = adjectives[Math.floor(Math.random()*adjectives.length)];
            const ani = animals[Math.floor(Math.random()*animals.length)];
            const num = Math.floor(100 + Math.random()*900);
            return `${adj}-${ani}-${num}`;
        }

        function renderCategorySummary() {
            const wrap = document.getElementById('categorySummary');
            if (!wrap) return;
            wrap.innerHTML = '';
            const order = ['A','B','C','D','E','F','G','H','I','J','K','L','N'];
            order.forEach(key => {
                const label = (categoryLabels && categoryLabels[key]) ? categoryLabels[key] : key;
                const chip = document.createElement('span');
                chip.className = 'chip';
                chip.textContent = label;
                wrap.appendChild(chip);
            });
        }

        function sortLeftByInitialOrder() {
            const container = document.querySelector('.descriptions');
            if (!container) return;
            const items = Array.from(container.querySelectorAll('.description-item'));
            items.sort((a, b) => {
                const ai = initialOrderIndex[a.getAttribute('data-description')] ?? 0;
                const bi = initialOrderIndex[b.getAttribute('data-description')] ?? 0;
                return ai - bi;
            });
            items.forEach(el => container.appendChild(el));
        }

        function reshuffleLists() {
            const descriptionsContainer = document.querySelector('.descriptions');
            const categoriesContainer = document.querySelector('.categories');
            if (descriptionsContainer) {
                shuffleChildren(descriptionsContainer, '.description-item');
            }
            if (categoriesContainer) {
                shuffleChildren(categoriesContainer, '.category-item');
            }
            // 새 셔플 기준으로 초기 인덱스 갱신
            initialOrderIndex = {};
            if (descriptionsContainer) {
                const items = descriptionsContainer.querySelectorAll('.description-item');
                items.forEach((el, idx) => {
                    const id = el.getAttribute('data-description');
                    if (id) initialOrderIndex[id] = idx;
                });
            }
        }

        function startGame() {
            // 이메일 입력 UI가 없으면 별명 기반 익명 이메일을 생성
            const emailInput = document.getElementById('emailInput');
            let email = '';
            if (emailInput) {
                email = emailInput.value;
                if (!email || !validateEmail(email)) {
                    alert('유효한 이메일 주소를 입력해주세요.');
                    return;
                }
            } else {
                // 닉네임(+숫자)만 사용해 이메일 필드 채움(도메인 제거)
                const nick = userNickname || getOrCreateNickname();
                email = `${nick}`;
            }

            userEmail = email;
            // 별명은 (가능하면) 로컬스토리지 값을 사용
            userNickname = getOrCreateNickname();
            gameResults = {};
            document.getElementById('emailForm').style.display = 'none';
            document.getElementById('gameArea').style.display = 'block';
            document.getElementById('userInfo').textContent = `플레이어: ${userEmail}`;
            const resultSection = document.getElementById('resultSection');
            if (resultSection) resultSection.style.display = 'block';
        }

        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        function allowDrop(ev) {
            ev.preventDefault();
            ev.currentTarget.classList.add('drag-over');
        }

        function drag(ev) {
            ev.dataTransfer.setData("text", ev.target.getAttribute('data-description'));
            ev.target.classList.add('dragging');
        }

        function drop(ev) {
            ev.preventDefault();
            ev.currentTarget.classList.remove('drag-over');
            
            const descriptionId = ev.dataTransfer.getData("text");
            const categoryId = ev.currentTarget.getAttribute('data-category');
            const descriptionElement = document.querySelector(`[data-description="${descriptionId}"]`);
            
            if (descriptionElement) {
                descriptionElement.classList.remove('dragging');
                descriptionElement.classList.add('matched');
                descriptionElement.classList.add('in-category');

                const itemsContainer = document.getElementById(`category${categoryId}-items`);
                if (!itemsContainer) return;

                // 카테고리로 실제 요소를 이동
                itemsContainer.appendChild(descriptionElement);

                // 매칭 결과 갱신
                gameResults[descriptionId] = categoryId;
            }
        }

        // 왼쪽 영역으로 드롭하면 원래 리스트로 복귀
        function dropToLeft(ev) {
            ev.preventDefault();
            ev.currentTarget.classList.remove('drag-over');

            const descriptionId = ev.dataTransfer.getData("text");
            const descriptionElement = document.querySelector(`[data-description="${descriptionId}"]`);
            const descriptionsContainer = document.querySelector('.descriptions');

            if (descriptionElement && descriptionsContainer) {
                descriptionElement.classList.remove('dragging');
                descriptionElement.classList.remove('matched');
                descriptionElement.classList.remove('in-category');
                descriptionsContainer.appendChild(descriptionElement);
                // 매칭 해제
                delete gameResults[descriptionId];
                // 초기 순서대로 정렬
                sortLeftByInitialOrder();
            }
        }

        function handleResetButtonClick() {
            const descriptionsContainer = document.querySelector('.descriptions');
            const allDesc = Array.from(document.querySelectorAll('.description-item'));

            allDesc.forEach(el => {
                el.classList.remove('dragging');
                el.classList.remove('matched');
                el.classList.remove('in-category');
                descriptionsContainer.appendChild(el);
            });

            // 초기 순서대로 정렬
            sortLeftByInitialOrder();

            // 결과 초기화
            gameResults = {};

            // 결과 영역 숨김
            const resultsDisplay = document.getElementById('resultsDisplay');
            const matchResults = document.getElementById('matchResults');
            if (matchResults) matchResults.innerHTML = '';
            if (resultsDisplay) resultsDisplay.style.display = 'none';

            // 시각적 상태 초기화
            document.querySelectorAll('.category-item').forEach(item => item.classList.remove('drag-over'));
            const desc = document.querySelector('.descriptions');
            if (desc) desc.classList.remove('drag-over');
        }

        document.addEventListener('dragend', function(e) {
            document.querySelectorAll('.category-item').forEach(item => {
                item.classList.remove('drag-over');
            });
            const desc = document.querySelector('.descriptions');
            if (desc) desc.classList.remove('drag-over');
            document.querySelectorAll('.description-item').forEach(item => {
                item.classList.remove('dragging');
            });
        });

        function handleSaveButtonClick() {
            if (!userEmail) {
                alert('먼저 이메일을 입력하고 게임을 시작해주세요.');
                return;
            }

            if (Object.keys(gameResults).length === 0) {
                alert('아직 매칭된 항목이 없습니다. 먼저 카테고리와 설명을 매칭해주세요.');
                return;
            }

            const matchResultSummary = collectMatchResultSummary();
            if (!matchResultSummary) {
                alert('저장할 매칭 결과를 찾을 수 없습니다.');
                return;
            }

            const now = new Date();
            const timestampIso = now.toISOString();
            const timestampDisplay = now.toLocaleString('ko-KR');

            setSavingUI(true);

            saveToSheetToAppsScript({
                email: userEmail,
                matchResult: matchResultSummary,
                matches: { ...gameResults },
                timestamp: timestampIso,
                onSuccess: () => {
                    setSavingUI(false);
                    alert('매칭 결과가 구글 스프레드시트에 저장되었습니다.');
                    renderMatchResults(timestampDisplay);
                    lockGameUI();
                },
                onError: (error) => {
                    console.error('스프레드시트 저장 실패:', error);
                    setSavingUI(false);
                    alert(`스프레드시트 저장에 실패했습니다.\n${error.message || error}`);
                }
            });
        }

        function setSavingUI(saving) {
            const btn = document.getElementById('save-button');
            const bar = document.getElementById('saveProgress');
            if (!btn || !bar) return;
            if (saving) {
                btn.disabled = true;
                if (!btn.dataset.label) btn.dataset.label = btn.textContent;
                btn.textContent = '저장 중...';
                bar.style.display = 'block';
            } else {
                btn.disabled = false;
                if (btn.dataset.label) btn.textContent = btn.dataset.label;
                bar.style.display = 'none';
            }
        }

        function lockGameUI() {
            const desc = document.querySelector('.descriptions');
            const cats = document.querySelector('.categories');
            if (desc) desc.classList.add('disable-interaction');
            if (cats) cats.classList.add('disable-interaction');
            document.querySelectorAll('.description-item').forEach(el => el.setAttribute('draggable', 'false'));
            const resetBtn = document.getElementById('reset-button');
            if (resetBtn) resetBtn.disabled = true;
            const saveBtn = document.getElementById('save-button');
            if (saveBtn) saveBtn.disabled = true;
            const backBtn = document.getElementById('back-button');
            if (backBtn) backBtn.style.display = 'inline-flex';
        }

        function unlockGameUI() {
            const desc = document.querySelector('.descriptions');
            const cats = document.querySelector('.categories');
            if (desc) desc.classList.remove('disable-interaction');
            if (cats) cats.classList.remove('disable-interaction');
            document.querySelectorAll('.description-item').forEach(el => el.setAttribute('draggable', 'true'));
            const resetBtn = document.getElementById('reset-button');
            if (resetBtn) resetBtn.disabled = false;
            const saveBtn = document.getElementById('save-button');
            if (saveBtn) saveBtn.disabled = false;
            const backBtn = document.getElementById('back-button');
            if (backBtn) backBtn.style.display = 'none';
        }

        function handleBackButtonClick() {
            // 화면 전환: 홈이 아닌, 게임 시작 상태로 복귀
            const emailForm = document.getElementById('emailForm');
            const gameArea = document.getElementById('gameArea');
            const resultSection = document.getElementById('resultSection');
            if (emailForm) emailForm.style.display = 'none';
            if (gameArea) gameArea.style.display = 'block';
            if (resultSection) resultSection.style.display = 'block';

            // 상태 초기화 (결과 패널은 숨기고, 결과 내용 비움)
            const resultsDisplay = document.getElementById('resultsDisplay');
            const matchResults = document.getElementById('matchResults');
            if (matchResults) matchResults.innerHTML = '';
            if (resultsDisplay) resultsDisplay.style.display = 'none';

            // 진행바/버튼 상태 초기화
            setSavingUI(false);
            const backBtn = document.getElementById('back-button');
            if (backBtn) backBtn.style.display = 'none';

            // 항목 복귀 및 셔플
            const descriptionsContainer = document.querySelector('.descriptions');
            const allDesc = Array.from(document.querySelectorAll('.description-item'));
            allDesc.forEach(el => {
                el.classList.remove('dragging', 'matched', 'in-category');
                if (descriptionsContainer) descriptionsContainer.appendChild(el);
            });
            reshuffleLists();

            // 게임 상태 초기화 및 UI 활성화
            gameResults = {};
            unlockGameUI();

            // 상단 유저 정보 갱신(별명 유지)
            const userInfo = document.getElementById('userInfo');
            if (userInfo) {
                const nick = userNickname || getOrCreateNickname();
                userEmail = nick;
                userInfo.textContent = `플레이어: ${userEmail}`;
            }
        }

        function collectMatchResultSummary() {
            if (Object.keys(gameResults).length === 0) {
                return '';
            }

            return Object.entries(gameResults)
                .map(([descriptionKey, categoryKey]) => {
                    const descriptionLabel = descriptionLabels[descriptionKey] || descriptionKey;
                    const categoryLabel = categoryLabels[categoryKey] || categoryKey;
                    return `${descriptionLabel} → ${categoryLabel}`;
                })
                .join(', ');
        }

        async function saveToSheetToAppsScript({ email, matchResult, matches, timestamp, onSuccess, onError }) {
            if (!SCRIPT_URL || SCRIPT_URL.includes('REPLACE_WITH_YOUR_WEB_APP_ID')) {
                const error = new Error('Apps Script 웹앱 URL이 설정되지 않았습니다.');
                if (typeof onError === 'function') {
                    onError(error);
                }
                return;
            }

            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({
                        email,
                        timestamp,
                        matchResult,
                        matches
                    })
                });

                if (typeof onSuccess === 'function') {
                    onSuccess();
                }
            } catch (error) {
                if (typeof onError === 'function') {
                    onError(error);
                }
            }
        }

        function renderMatchResults(timestampDisplay) {
            const matchResultsDiv = document.getElementById('matchResults');
            matchResultsDiv.innerHTML = '';

            Object.entries(gameResults).forEach(([descriptionKey, categoryKey]) => {
                const descriptionLabel = descriptionLabels[descriptionKey] || descriptionKey;
                const categoryLabel = categoryLabels[categoryKey] || categoryKey;

                const matchDiv = document.createElement('div');
                matchDiv.className = 'match-result';
                matchDiv.innerHTML = `<strong>${descriptionLabel}</strong> → <strong>${categoryLabel}</strong>`;
                matchResultsDiv.appendChild(matchDiv);
            });

            const summaryDiv = document.createElement('div');
            summaryDiv.style.marginTop = '15px';
            summaryDiv.style.padding = '10px';
            summaryDiv.style.background = 'var(--matched-bg)';
            summaryDiv.style.border = '1px solid var(--success)';
            summaryDiv.style.borderRadius = '5px';
            summaryDiv.innerHTML = `<strong>저장 완료!</strong><br>플레이어: ${userEmail}<br>저장 시간: ${timestampDisplay}`;
            matchResultsDiv.appendChild(summaryDiv);

            document.getElementById('resultsDisplay').style.display = 'block';
        }
    </script>
</body>
</html>
